---
title: "Etude sur les vacations/heures complémentaires"
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)

library(ggplot2)
library(plyr)
library(tidyverse)
library(ggrepel)
library(plotly)
library(ggthemes)

bs <- read.csv("Extraction_BS.csv",header=TRUE, sep=";", quote='"') %>%
        filter(Rentrée>2010) %>%
        filter(HC.Total != "NA")
        
      
hec <- merge(select(bs,-Type),kpiESR::esr)
    #filter(Etablissement != "Montpellier")%>%
   # filter(Rentrée == 2018)

```



## Quelques dataviz

On commence par le nb d'heures hors service en fonction du nb de titulaires, en gardant les data à partir de 2014.

```{r hcompPtit}
hec %>%
  filter(Rentrée > 2013)%>%
  group_by(Etablissement) %>%
  summarize(hcm=mean(HC.Total, na.rm=TRUE),titmean=mean(kpi.ENS.S.titulaires,na.rm=TRUE)) %>%

ggplot(aes(y = hcm/titmean, x = titmean,#100*titPetunorm,
           label = Etablissement,
           color = Etablissement)) +
  geom_point() + geom_text_repel() + 
  ylim(0,450)+
  xlim(0,3000)+
  ylab("Nb d'heures comp+vacations / enseignant titulaire") +
  xlab("Nb d'enseignants titulaires") +
  guides(color=FALSE)


```

On continue en regardant la variation (en %) du nombre d'HComp par tous les établissements. Cette variation est obtenue, pour chaque établissement, en regardant l'écart à la moyenne sur la période 2014-2018.
La transparence représente cette valeur moyenne (moins c'est transparent, plus le nombre d'heures moyen est élevé)





```{r evol.hcomp}
df <- hec %>%
  filter(Rentrée > 2012)%>%
            group_by(Etablissement) %>%
  summarize(Rentrée,HC.Total,hcm=mean(HC.Total, na.rm=TRUE),)%>%
  mutate(
    hecPnorm = (HC.Total-hcm)/hcm)
  


ggplot(df, aes(y = 100*hecPnorm, x = Rentrée,
           color=(Etablissement),alpha=hcm)) +
  geom_point()+
  geom_line()+
  geom_text_repel(data=filter(df,Rentrée == 2018), aes(label=Etablissement), hjust=0, direction="y", size=2) +
  xlab("Annee")+
  ylab("Variation du nombre d'heures complémentaires (en %)")+
  xlim(2013,2019)+
  scale_alpha(range = c(0.2, 1))+
  guides(color=FALSE)
```  

Et enfin, on essaie de regarder ces trajectoires dans le plan HComp,Nb de titulaires avec des gradients de transparence pour figurer l'année

```{r trajectoires}
  df <- hec %>%
    mutate(
      hecPtit = HC.Titulaires / kpi.ENS.S.titulaires,
      hecPhec = HC.Vacataires / HC.Total,
      HtPtit = HC.Total/kpi.ENS.S.titulaires
    ) %>%
    filter(Rentrée > 2011)

  ggplot(df, aes(x=kpi.ENS.S.titulaires, y=HC.Total/kpi.ENS.S.titulaires, 
                 alpha=Rentrée, color=as.factor(Libellé))) + 
    geom_point() + geom_path() +
    geom_text(data=filter(df, Rentrée == 2018), aes(label=Libellé), hjust=0, angle = 45, size=2.5) +
    scale_alpha(range = c(0.1, 1))+
    guides(color=FALSE)+
     xlab("Nombre d'enseignants titulaires")+
  ylab("Nombre d'heures compl. + vacations / enseignant titulaire")+
    ylim(0,450)+
    xlim(0,3000)
```


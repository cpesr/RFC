---
title: "Etude sur les vacations/heures complémentaires"
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)

library(ggplot2)
library(plyr)
library(tidyverse)
library(ggrepel)
library(plotly)
library(ggthemes)

bs <- read.csv("Extraction_BS.csv",header=TRUE, sep=";", quote='"') %>%
        filter(Rentrée>2010) %>%
        filter(HC.Total != "NA")
        
      
hec <- merge(select(bs,-Type),kpiESR::esr)
    #filter(Etablissement != "Montpellier")%>%
   # filter(Rentrée == 2018)

```



## Quelques visualisations

On propose ici une première analyse des heures de "vacations" à l'université. Nous avons collecté les bilans sociaux des établissements listés ci-dessous sur une période allant de 2005 à 2018. Le corpus est fragmentaire et nécessite d'être complété, mais constitue une première base d'analyse. Nous restreignons volontairement l'analyse à la période 2014-2018 pour avoir suffisament d'établissements.

Liste des établissements : 

```{r etablissement}
liste_etab<-hec%>%
  filter(Rentrée > 2013)%>%
  group_by(Etablissement) %>%
  summarize()
  
  liste_etab$Etablissement
  
```

Définitions : 

- Les heures complémentaires sont les heures réalisées par des employés de l'établissement (titulaires ou contractuels) au delà de leur obligation de service.
- Les vacations d'enseignement sont les heures d'enseignement réalisées par des extérieurs à l'établissement (fonctionnaires ou non).

- Les volumes horaires sont exprimés en Heures équivalent TD (HETD)

Dans la suite, on considère l'ensemble des heures hors service, à savoir la somme des heures complémentaires et des vacations d'enseignement. Une analyse plus fine pourra être menée dans un second temps.

## Heures hors service et taille des établissement

On commence par le nb d'heures hors service (=heures complémentaires + vacations d'enseignement) en fonction du nb de titulaires, en gardant les data moyen à partir de 2014 et pour chaque établissement.

```{r hcompPtit}
hec %>%
  filter(Rentrée > 2013)%>%
  group_by(Etablissement) %>%
  summarize(hcm=mean(HC.Total, na.rm=TRUE),titmean=mean(kpi.ENS.S.titulaires,na.rm=TRUE)) %>%

ggplot(aes(y = hcm/titmean, x = titmean,#100*titPetunorm,
           label = Etablissement,
           color = Etablissement)) +
  geom_point() + geom_text_repel() + 
  ylim(0,450)+
  xlim(0,3000)+
  ylab("Nb d'heures hors service / enseignant titulaire") +
  xlab("Nb d'enseignants titulaires") +
  labs(caption = "Graphique : Camille Noûs et CPESR - Data : Bilans sociaux des établissements") +
  guides(color=FALSE)


```

On constate graphiquement que les petits établissements font davantage appel à des heures hors service que les gros.

## Evolution du nb d'heures complémentaires



On continue en regardant la variation (en %) du nombre d'heures hors service par tous les établissements. Cette variation est obtenue, pour chaque établissement, en regardant l'écart à la moyenne sur la période 2014-2018.
La transparence représente cette valeur moyenne (moins c'est transparent, plus le nombre d'heures moyen est élevé).





```{r evol.hcomp}
df <- hec %>%
  filter(Rentrée > 2012)%>%
            group_by(Etablissement) %>%
  summarize(Rentrée,HC.Total,hcm=mean(HC.Total, na.rm=TRUE),titmean=mean(kpi.ENS.S.titulaires,na.rm=TRUE),etabtaill=sign(titmean-750))%>%
  mutate(
    hecPnorm = (HC.Total-hcm)/hcm)
  


ggplot(df, aes(y = 100*hecPnorm, x = Rentrée,
           color=(Etablissement),alpha=hcm)) +
  geom_point()+
  geom_line()+
  geom_text_repel(data=filter(df,Rentrée == 2018), aes(label=Etablissement), hjust=0, direction="y", size=2) +
  xlab("Annee")+
  ylab("Variation du nombre d'heures hors service (en %)")+
  xlim(2013,2019)+
  scale_alpha(range = c(0.2, 1))+
  labs(caption = "Graphique : Camille Noûs et CPESR - Data : Bilans sociaux des établissements") +
  guides(color=FALSE)
```  

Une autre visualisation qui ne distingue plus entre les établissements mais qui montre la tendance à l'augmentation des heures hors service sur la période. On crée un boxplot qui agrège les données de tous les établissements.

```{r evol.hcomp.2}

df2<- df%>%  
  group_by(Rentrée) %>%
  mutate(Rentrée = as.factor(Rentrée)
         
         )%>%
    summarize(Rentrée,hecPnorm,hcm,etabtaill,titmean)        



  ggplot(df2, aes(x=Rentrée, y=hecPnorm)) +
    geom_boxplot()+
    scale_y_continuous(labels=scales::percent) +
     labs(title="Evolution relative du nb d'Heures hors service", x ="Année", y = "Variation du nombre d'heures hors service") +
   labs(caption = "Graphique : Camille Noûs et CPESR - Data : Bilans sociaux des établissements") +
  theme_hc()

```
```{r evol.hcomp.3}
ggplot(df2, aes(x=Rentrée, y=hecPnorm, group=Rentrée, fill="TRUE")) +
    geom_violin() +
    theme(legend.position="none") +
      scale_y_continuous(labels=scales::percent) +
  guides(fill= FALSE)+
    coord_cartesian(ylim=c(-.2,.2)) +
    labs(title="Evolution relative du nb d'Heures hors service", x ="Année", y = "Variation du nombre d'heures hors service") +
   labs(caption = "Graphique : Camille Noûs et CPESR - Data : Bilans sociaux des établissements") +
  theme_hc()

```



## Effet de la taille des établissements

On a constaté (figure 1) qu'il existe deux populations d'établissements, avec un recours différent aux heures hors service. Est-ce que cette distinction se traduit également dans l'évolution temporelle observée ?

On commence par séparer les deux populations avec 750 titulaires comme séparation (choix arbitraire). 


```{r evol.hcomp.taille.1}

ggplot(df2,aes(y = hcm/titmean, x = titmean,#100*titPetunorm,
           color = etabtaill)) +
  geom_point() +
  
  ylim(0,450)+
  xlim(0,3000)+
  ylab("Nb d'heures hors service / enseignant titulaire") +
  xlab("Nb d'enseignants titulaires") +
labs(caption = "Graphique : Camille Noûs et CPESR - Data : Bilans sociaux des établissements") +
  guides(color=FALSE)


```


On trace l'évolution pour chacun des groupes sur la période 2014-2018



```{r evol.hcomp.taille.2}

df2%>%

ggplot(aes(x=Rentrée, y=hecPnorm)) +
    geom_boxplot()+
    scale_y_continuous(labels=scales::percent) +
  facet_wrap(.~etabtaill, labeller = labeller(etabtaill = 
    c("-1" = "<750 Ens. titulaires",
      "1" = ">750 Ens. titulaires")))+
  coord_cartesian(ylim=c(-0.15,.15))+
     labs(title="Evolution relative du nb d'Heures hors service", x ="Année", y = "Variation du nombre d'heures hors service") +
labs(caption = "Graphique : Camille Noûs et CPESR - Data : Bilans sociaux des établissements") +
  theme_hc()
```

```{r evol.hcomp.taille.3}

df2%>%

ggplot(aes(x=Rentrée, y=hecPnorm, fill="TRUE")) +
   geom_violin() +
    scale_y_continuous(labels=scales::percent) +
  facet_wrap(.~etabtaill, labeller = labeller(etabtaill = 
    c("-1" = "<750 Ens. titulaires",
      "1" = ">750 Ens. titulaires")))+
  guides(fill= FALSE)+
  coord_cartesian(ylim=c(-0.15,.15))+
     labs(title="Evolution relative du nb d'Heures hors service", x ="Année", y = "Variation du nombre d'heures hors service") +
    labs(caption = "Graphique : Camille Noûs et CPESR - Data : Bilans sociaux des établissements") +
  theme_hc()
```


A première vue, on ne voit pas de différences majeures en fonction de la taille des établissements. Cette analyse doit être confirmée.


## Autres approches

Enfin, on essaie de regarder les trajectoires suivies par les établissements dans le plan (Heures hors service ; Nb de titulaires) avec des gradients de transparence pour figurer l'année

```{r trajectoires}
  df <- hec %>%
    mutate(
      hecPtit = HC.Titulaires / kpi.ENS.S.titulaires,
      hecPhec = HC.Vacataires / HC.Total,
      HtPtit = HC.Total/kpi.ENS.S.titulaires
    ) %>%
    filter(Rentrée > 2011)

  ggplot(df, aes(x=kpi.ENS.S.titulaires, y=HC.Total/kpi.ENS.S.titulaires, 
                 alpha=Rentrée, color=as.factor(Libellé))) + 
    geom_point() + geom_path() +
    geom_text(data=filter(df, Rentrée == 2018), aes(label=Libellé), hjust=0, angle = 45, size=2.5) +
    scale_alpha(range = c(0.1, 1))+
    guides(color=FALSE)+
     xlab("Nombre d'enseignants titulaires")+
  ylab("Nombre d'heures compl. + vacations / enseignant titulaire")+
    ylim(0,450)+
    xlim(0,3000)
```

## A venir

Analyse différenciée entre les heures complémentaires et les vacations d'enseignement.

## Crédits

Collecte et mise en forme des données : Antonin Eddi, Florent Figon, Julien Gossa et Camille Noûs pour CPESR 
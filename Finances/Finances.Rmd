---
title: "RFC Finances"
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
library(tidyverse)
library(ggcpesrthemes)
```


```{r load}
fin <- read.csv("fr-esr-operateurs-indicateurs-financiers.csv",sep=";",quote='"') %>%
  mutate(exercice = as.factor(exercice)) %>%
  mutate(groupe = case_when(
    startsWith(groupe,"université") ~ "université",
    groupe == "école d'ingénieurs" ~ "écoles d'ingénieurs",
    str_length(groupe) == 0 ~ "autres établissements d'enseignement et de recherche",
    TRUE ~ groupe
  )) %>%
  mutate(etablissement = case_when(
    str_length(etablissement) == 0 ~ uai...identifiant,
    TRUE ~ etablissement
  )) %>%
  mutate(
    groupe = as.factor(groupe),
    etablissement = as.factor(etablissement))

categories <- read.csv("indicateurs-financiers-categories.csv") 
levels.indicateurs <- categories$Indicateur
levels.categories <- unique(categories$Catégorie)

fin.pivot <- fin %>%
  pivot_longer(
    cols = Acquisitions.d.immobilisations:Valorisation,
    names_to = "Indicateur",
    values_to = "Valeur"
  ) %>%
  merge(categories) %>%
  mutate(
    Indicateur = factor(Indicateur,levels.indicateurs),
    Catégorie = factor(Catégorie,levels.categories)) %>%
  arrange(etablissement,Catégorie,Indicateur,exercice)

fin.pivot.groupe <- fin.pivot %>%
  group_by(groupe,exercice,Catégorie,Indicateur) %>%
  summarise(
    Somme = sum(Valeur, na.rm = TRUE),
    Moyenne = mean(Valeur, na.rm = TRUE)) %>%
  mutate(etablissement="Groupe")

fin.pivot.total <- fin.pivot %>%
  group_by(exercice,Catégorie,Indicateur) %>%
  summarise(
    Somme = sum(Valeur, na.rm = TRUE),
    Moyenne = mean(Valeur, na.rm = TRUE)) %>%
  mutate(groupe="Global", etablissement="Global")
```

Jeu de données :
https://data.enseignementsup-recherche.gouv.fr/explore/dataset/fr-esr-operateurs-indicateurs-financiers/information/


Problèmes détectés :

- `CAF / Acquisitions d’immobilisations` dans le modèle mais absent des données
- `Ressources.propres` dans les données, et `Ressources propres encaissables` dans le modèle
- Nombreux `groupe` et `etablissement` vides

## Tous les indicateurs aggrégés

_Attention_ : 

- Il s'agit d'un traitement global, et certaines aggrégation n'ont pas de sens. C'est le cas typiquement de la sommes de rapports (du type Ressources propres / Produits encaissable).
- Il y a des changements de périmètre dans les données (des établissements entrant ou sortant du périmètre du MESRI, et des établissements changeant de groupe).


```{r aggreg, fig.width=10, fig.height=60}
fin.pivot.total %>%
  pivot_longer(
    cols=Somme:Moyenne,
    names_to="Aggrégation",
    values_to="Valeur") %>%
  ggplot(aes(x=exercice,y=Valeur,color=groupe)) +
    geom_point(size=2) + geom_line(aes(group=groupe)) +
    facet_wrap(Indicateur~Aggrégation, scales="free", ncol=2) +
    theme_cpesr() +
    theme(legend.direction="vertical")
```



## Tous les indicateurs aggrégés par groupe


```{r aggreg.grp, fig.width=10, fig.height=60}
fin.pivot.groupe %>%
  pivot_longer(
    cols=Somme:Moyenne,
    names_to="Aggrégation",
    values_to="Valeur") %>%
  ggplot(aes(x=exercice,y=Valeur,color=groupe)) +
    geom_point(size=2) + geom_line(aes(group=groupe)) +
    facet_wrap(Indicateur~Aggrégation, scales="free", ncol=2) +
    theme_cpesr() +
    theme(legend.direction="vertical")
```


## Tous les indicateurs par établissement 

```{r etab, fig.width=10, fig.height=30}
etab = "Université de Strasbourg"
fin.etab <- fin.pivot %>% filter(etablissement == etab)
grp <- fin.etab$groupe[[1]]
fin.all <- bind_rows(
  fin.etab,
  fin.pivot.groupe %>% filter(groupe==grp) %>%  mutate(Valeur = Moyenne),
  fin.pivot.total %>%  mutate(Valeur = Moyenne)
  ) %>%
  mutate(
    etablissement = factor(etablissement, 
                           levels = c("Global","Groupe",etab),
                           labels = c("Moyenne globale",paste("Moyenne",grp),etab))
  )

fin.all %>% 
  ggplot(aes(x=exercice,y=Valeur,color=etablissement)) +
    geom_point(size=2) + geom_line(aes(group=etablissement)) +
    scale_color_brewer(palette="Purples") +
    facet_wrap(Indicateur~., scales="free", ncol=2) +
    theme_cpesr() +
    theme(legend.direction="vertical")
```


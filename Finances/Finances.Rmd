---
title: "RFC Finances"
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
library(tidyverse)
library(ggcpesrthemes)

source("Finances.R")
```

Jeu de données :
https://data.enseignementsup-recherche.gouv.fr/explore/dataset/fr-esr-operateurs-indicateurs-financiers/information/


Problèmes détectés :

- `CAF / Acquisitions d’immobilisations` dans le modèle mais absent des données
- `Ressources.propres` dans les données, et `Ressources propres encaissables` dans le modèle
- Nombreux `groupe` et `etablissement` vides

## Tous les indicateurs aggrégés

_Attention_ : 

- Il s'agit d'un traitement global, et certaines aggrégation n'ont pas de sens. C'est le cas typiquement de la sommes de rapports (du type Ressources propres / Produits encaissable).
- Il y a des changements de périmètre dans les données (des établissements entrant ou sortant du périmètre du MESRI, et des établissements changeant de groupe).


```{r aggreg, fig.width=10, fig.height=60}
fin.pivot.total %>%
  pivot_longer(
    cols=Somme:Moyenne,
    names_to="Aggrégation",
    values_to="Valeur") %>%
  ggplot(aes(x=exercice,y=Valeur,color=groupe)) +
    geom_point(size=2) + geom_line(aes(group=groupe)) +
    facet_wrap(Indicateur~Aggrégation, scales="free", ncol=2) +
    theme_cpesr() +
    theme(legend.direction="vertical")
```

## Tous les indicateurs aggrégés par groupe

```{r aggreg.grp, fig.width=10, fig.height=60}
fin.pivot.groupe %>%
  pivot_longer(
    cols=Somme:Moyenne,
    names_to="Aggrégation",
    values_to="Valeur") %>%
  ggplot(aes(x=exercice,y=Valeur,color=groupe)) +
    geom_point(size=2) + geom_line(aes(group=groupe)) +
    facet_wrap(Indicateur~Aggrégation, scales="free", ncol=2) +
    theme_cpesr() +
    theme(legend.direction="vertical")
```

## Tous les indicateurs par établissement


```{r production, include=FALSE, eval=TRUE}

slugify <- function(x, alphanum_replace="", space_replace="_", tolower=TRUE) {
  if(tolower) { x <- tolower(x) }

  return(x)
}


outmd <- function(x) {
  x <- gsub("[^[:alnum:] ]", "", x)
  x <- gsub(" ", "_", x)
  paste0(x,'.md')
}

etabs = c("Université de Strasbourg")
etabs = unique(fin$etablissement)
for(etab in etabs) {
  rmarkdown::render("Etablissement.Rmd",
                    output_dir = "Etablissements",
                    output_file = outmd(etab),
                    output_format=NULL,
                    clean = TRUE)
}
```



```{r production2, results="asis"}
for(etab in etabs) {
  cat("- [", etab,"](Etablissements/",outmd(etab),")\n", sep='')
}
```


